<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Tracker</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@500&display=swap" rel="stylesheet">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #fafaf9;
            --surface: #ffffff;
            --text: #1c1917;
            --text-muted: #78716c;
            --border: #e7e5e4;
            --accent: #0c4a6e;
            --accent-light: #e0f2fe;
            --success: #14532d;
            --success-light: #dcfce7;
        }

        body {
            font-family: 'IBM Plex Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .section {
            background: var(--surface);
            border: 1px solid var(--border);
            padding: 24px;
            margin-bottom: 24px;
            border-radius: 4px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        h2 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .section-desc {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-top: 4px;
        }

        input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.95rem;
            background: var(--bg);
            transition: border-color 0.2s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            transform: translateY(1px);
        }

        .btn-secondary {
            background: transparent;
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-small {
            padding: 4px 12px;
            font-size: 0.8rem;
        }

        .rock-item {
            border: 1px solid var(--border);
            padding: 16px;
            margin-bottom: 16px;
            border-radius: 4px;
            background: var(--bg);
            transition: all 0.3s;
        }

        .rock-item.no-progress {
            border-color: #fbbf24;
            background: #fffbeb;
        }

        .rock-item.completed {
            border-color: var(--success);
            background: var(--success-light);
        }

        @keyframes checkComplete {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .kr-checkbox:checked {
            animation: checkComplete 0.3s ease;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.05) rotate(-2deg); }
            75% { transform: scale(1.05) rotate(2deg); }
        }

        .rock-item.completed {
            animation: celebrate 0.5s ease;
        }

        .rock-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .rock-title {
            font-weight: 500;
            flex: 1;
            margin-right: 12px;
        }

        .rock-actions {
            display: flex;
            gap: 8px;
        }

        .kr-list {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .kr-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 0;
        }

        .kr-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .kr-text {
            flex: 1;
            font-size: 0.9rem;
        }

        .kr-text.completed {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .kr-numeric {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kr-numeric-input {
            width: 60px;
            padding: 4px 8px;
            font-size: 0.85rem;
            text-align: center;
        }

        .kr-numeric-display {
            font-family: 'IBM Plex Mono', monospace;
            font-size: 0.9rem;
            color: var(--accent);
            font-weight: 500;
        }

        .kr-numeric-bar {
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            overflow: hidden;
            flex: 1;
            min-width: 100px;
        }

        .kr-numeric-bar-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        .progress-bar {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-family: 'IBM Plex Mono', monospace;
        }

        .add-form {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .form-row {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .stats {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .stat-card {
            flex: 1;
            padding: 16px;
            background: var(--accent-light);
            border-radius: 4px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent);
            font-family: 'IBM Plex Mono', monospace;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .rock-counter {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-family: 'IBM Plex Mono', monospace;
            margin-left: 8px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            padding: 32px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .modal-text {
            color: var(--text-muted);
            margin-bottom: 24px;
            line-height: 1.7;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-buttons button {
            flex: 1;
        }

        @media (max-width: 600px) {
            .stats {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
            }

            .modal-content {
                padding: 24px;
            }

            .modal-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Constants
        const MAX_ROCKS = 7;

        // Helper function to parse Key Results and detect numeric targets
        const parseKeyResult = (text) => {
            // Buscar patrones como: "100 usuarios", "Conseguir 50 clientes", "20 entrevistas"
            const numericPattern = /\b(\d+)\b/;
            const match = text.match(numericPattern);
            
            if (match && parseInt(match[1]) > 1) {
                return {
                    id: Date.now(),
                    text: text,
                    type: 'numeric',
                    target: parseInt(match[1]),
                    current: 0
                };
            }
            
            return {
                id: Date.now(),
                text: text,
                type: 'checkbox',
                completed: false
            };
        };

        // Storage helper using window.storage API
        const storage = {
            async get(key) {
                try {
                    const result = await window.storage.get(key);
                    return result ? JSON.parse(result.value) : null;
                } catch (error) {
                    console.log('Key not found, returning null');
                    return null;
                }
            },
            async set(key, value) {
                try {
                    await window.storage.set(key, JSON.stringify(value));
                } catch (error) {
                    console.error('Storage error:', error);
                }
            }
        };

        function App() {
            const [vision, setVision] = useState('');
            const [rocks, setRocks] = useState([]);
            const [showAddRock, setShowAddRock] = useState(false);
            const [newRockTitle, setNewRockTitle] = useState('');
            const [showOnboarding, setShowOnboarding] = useState(false);

            // Load data on mount
            useEffect(() => {
                const loadData = async () => {
                    const savedVision = await storage.get('vision');
                    const savedRocks = await storage.get('rocks');
                    
                    if (!savedVision && (!savedRocks || savedRocks.length === 0)) {
                        setShowOnboarding(true);
                    }
                    
                    if (savedVision) setVision(savedVision);
                    if (savedRocks) setRocks(savedRocks);
                };
                loadData();
            }, []);

            // Save vision
            const saveVision = async (value) => {
                setVision(value);
                await storage.set('vision', value);
            };

            // Load example data from onboarding
            const loadExampleData = async () => {
                const exampleVision = 'Lanzar mi producto y conseguir mis primeros clientes';
                const exampleRocks = [
                    {
                        id: Date.now(),
                        title: 'Lanzar MVP del producto',
                        keyResults: [
                            { id: Date.now() + 1, text: 'Definir features core', completed: false },
                            { id: Date.now() + 2, text: 'Conseguir 5 usuarios beta', completed: false }
                        ]
                    },
                    {
                        id: Date.now() + 100,
                        title: 'Validar producto-mercado fit',
                        keyResults: [
                            { id: Date.now() + 101, text: '20 entrevistas con clientes potenciales', completed: false },
                            { id: Date.now() + 102, text: 'Identificar 3 pain points principales', completed: false }
                        ]
                    }
                ];
                
                setVision(exampleVision);
                setRocks(exampleRocks);
                await storage.set('vision', exampleVision);
                await storage.set('rocks', exampleRocks);
                setShowOnboarding(false);
            };

            // Start from scratch
            const startFromScratch = () => {
                setShowOnboarding(false);
            };

            // Add rock
            const addRock = async () => {
                const trimmedTitle = newRockTitle.trim();
                if (!trimmedTitle) return;
                if (rocks.length >= MAX_ROCKS) return;
                
                const newRock = {
                    id: Date.now(),
                    title: trimmedTitle,
                    keyResults: []
                };
                
                const updatedRocks = [...rocks, newRock];
                setRocks(updatedRocks);
                await storage.set('rocks', updatedRocks);
                setNewRockTitle('');
                setShowAddRock(false);
            };

            // Delete rock
            const deleteRock = async (id) => {
                const rock = rocks.find(r => r.id === id);
                const hasKeyResults = rock && rock.keyResults.length > 0;
                
                if (hasKeyResults) {
                    const confirmed = window.confirm('Â¿Seguro que quieres eliminar este Rock? Esto borrarÃ¡ tambiÃ©n todos sus Key Results.');
                    if (!confirmed) return;
                }
                
                const updatedRocks = rocks.filter(r => r.id !== id);
                setRocks(updatedRocks);
                await storage.set('rocks', updatedRocks);
            };

            // Add key result
            const addKeyResult = async (rockId, krText) => {
                if (!krText.trim()) return;
                
                const newKR = parseKeyResult(krText);
                
                const updatedRocks = rocks.map(rock => {
                    if (rock.id === rockId) {
                        return {
                            ...rock,
                            keyResults: [...rock.keyResults, newKR]
                        };
                    }
                    return rock;
                });
                
                setRocks(updatedRocks);
                await storage.set('rocks', updatedRocks);
            };

            // Toggle key result
            const toggleKeyResult = async (rockId, krId) => {
                const updatedRocks = rocks.map(rock => {
                    if (rock.id === rockId) {
                        return {
                            ...rock,
                            keyResults: rock.keyResults.map(kr => 
                                kr.id === krId ? { ...kr, completed: !kr.completed } : kr
                            )
                        };
                    }
                    return rock;
                });
                
                setRocks(updatedRocks);
                await storage.set('rocks', updatedRocks);
            };

            // Update numeric key result
            const updateNumericKR = async (rockId, krId, newValue) => {
                const updatedRocks = rocks.map(rock => {
                    if (rock.id === rockId) {
                        return {
                            ...rock,
                            keyResults: rock.keyResults.map(kr =>
                                kr.id === krId ? { ...kr, current: Math.min(Math.max(0, newValue), kr.target) } : kr
                            )
                        };
                    }
                    return rock;
                });
                
                setRocks(updatedRocks);
                await storage.set('rocks', updatedRocks);
            };

            // Delete key result
            const deleteKeyResult = async (rockId, krId) => {
                const updatedRocks = rocks.map(rock => {
                    if (rock.id === rockId) {
                        return {
                            ...rock,
                            keyResults: rock.keyResults.filter(kr => kr.id !== krId)
                        };
                    }
                    return rock;
                });
                
                setRocks(updatedRocks);
                await storage.set('rocks', updatedRocks);
            };

            // Calculate stats
            const totalKRs = rocks.reduce((sum, rock) => sum + rock.keyResults.length, 0);
            const completedKRs = rocks.reduce((sum, rock) => 
                sum + rock.keyResults.filter(kr => {
                    if (kr.type === 'numeric') {
                        return kr.current >= kr.target;
                    }
                    return kr.completed;
                }).length, 0
            );
            const completionRate = totalKRs > 0 ? Math.round((completedKRs / totalKRs) * 100) : 0;

            return (
                <div className="container">
                    {showOnboarding && (
                        <div className="modal-overlay">
                            <div className="modal-content">
                                <div className="modal-header">
                                    ðŸŽ¯ Bienvenido a Goal Tracker
                                </div>
                                <div className="modal-text">
                                    <p style={{ marginBottom: '12px' }}>
                                        Esta app te ayuda a alcanzar tus objetivos combinando dos metodologÃ­as poderosas:
                                    </p>
                                    <ul style={{ marginLeft: '20px', marginBottom: '12px' }}>
                                        <li><strong>VisiÃ³n:</strong> Tu objetivo principal del aÃ±o</li>
                                        <li><strong>Rocks:</strong> 3-7 prioridades del trimestre</li>
                                        <li><strong>Key Results:</strong> MÃ©tricas medibles para cada Rock</li>
                                    </ul>
                                    <p>
                                        Â¿Quieres empezar con un ejemplo para ver cÃ³mo funciona?
                                    </p>
                                </div>
                                <div className="modal-buttons">
                                    <button className="btn-secondary" onClick={startFromScratch}>
                                        Empezar desde cero
                                    </button>
                                    <button onClick={loadExampleData}>
                                        Cargar ejemplo
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    <header>
                        <h1>Goal Tracker</h1>
                        <p className="subtitle">OKRs + Traction â€¢ Q1 2026</p>
                    </header>

                    {/* Vision */}
                    <div className="section">
                        <h2>VisiÃ³n Anual</h2>
                        <p className="section-desc">Â¿DÃ³nde quieres estar al final del aÃ±o?</p>
                        <textarea
                            value={vision}
                            onChange={(e) => saveVision(e.target.value)}
                            placeholder="Ej: Lanzar mi SaaS y generar $10K MRR este aÃ±o"
                            style={{ marginTop: '12px' }}
                        />
                    </div>

                    {/* Stats */}
                    <div className="stats">
                        <div className="stat-card">
                            <div className="stat-value">{rocks.length}</div>
                            <div className="stat-label">Rocks Activos</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{completedKRs}/{totalKRs}</div>
                            <div className="stat-label">Key Results</div>
                        </div>
                        <div className="stat-card">
                            <div className="stat-value">{completionRate}%</div>
                            <div className="stat-label">Completado</div>
                        </div>
                    </div>

                    {/* Rocks */}
                    <div className="section">
                        <div className="section-header">
                            <div>
                                <h2>Rocks del Trimestre <span className="rock-counter">{rocks.length}/{MAX_ROCKS}</span></h2>
                                <p className="section-desc">3-7 prioridades principales (90 dÃ­as)</p>
                            </div>
                            <button 
                                onClick={() => setShowAddRock(!showAddRock)}
                                disabled={rocks.length >= MAX_ROCKS && !showAddRock}
                            >
                                {showAddRock ? 'Cancelar' : rocks.length >= MAX_ROCKS ? `MÃ¡ximo ${MAX_ROCKS} Rocks` : '+ Rock'}
                            </button>
                        </div>

                        {showAddRock && (
                            <div className="add-form">
                                <div className="form-row">
                                    <input
                                        value={newRockTitle}
                                        onChange={(e) => setNewRockTitle(e.target.value)}
                                        placeholder="Ej: Conseguir primeros 100 usuarios"
                                        onKeyPress={(e) => e.key === 'Enter' && addRock()}
                                        autoFocus
                                    />
                                    <button onClick={addRock}>Agregar</button>
                                </div>
                            </div>
                        )}

                        {rocks.length === 0 ? (
                            <div className="empty-state">
                                <p>No hay Rocks definidos. Â¡Agrega tu primer objetivo!</p>
                            </div>
                        ) : (
                            rocks.map(rock => (
                                <Rock
                                    key={rock.id}
                                    rock={rock}
                                    onDelete={() => deleteRock(rock.id)}
                                    onAddKR={(text) => addKeyResult(rock.id, text)}
                                    onToggleKR={(krId) => toggleKeyResult(rock.id, krId)}
                                    onUpdateNumericKR={(krId, value) => updateNumericKR(rock.id, krId, value)}
                                    onDeleteKR={(krId) => deleteKeyResult(rock.id, krId)}
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        }

        function Rock({ rock, onDelete, onAddKR, onToggleKR, onUpdateNumericKR, onDeleteKR }) {
            const [showAddKR, setShowAddKR] = useState(false);
            const [newKRText, setNewKRText] = useState('');

            const handleAddKR = () => {
                if (newKRText.trim()) {
                    onAddKR(newKRText);
                    setNewKRText('');
                    setShowAddKR(false);
                }
            };

            const progress = rock.keyResults.length > 0
                ? (rock.keyResults.filter(kr => {
                    if (kr.type === 'numeric') {
                        return kr.current >= kr.target;
                    }
                    return kr.completed;
                  }).length / rock.keyResults.length) * 100
                : 0;

            const isCompleted = progress === 100;
            const hasNoProgress = rock.keyResults.length === 0 || progress === 0;
            const rockClassName = `rock-item ${isCompleted ? 'completed' : ''} ${hasNoProgress ? 'no-progress' : ''}`;

            return (
                <div className={rockClassName}>
                    <div className="rock-header">
                        <div className="rock-title">{rock.title}</div>
                        <div className="rock-actions">
                            <button 
                                className="btn-secondary btn-small"
                                onClick={() => setShowAddKR(!showAddKR)}
                            >
                                + KR
                            </button>
                            <button 
                                className="btn-secondary btn-small"
                                onClick={onDelete}
                            >
                                âœ•
                            </button>
                        </div>
                    </div>

                    {showAddKR && (
                        <div className="form-row" style={{ marginBottom: '12px' }}>
                            <input
                                value={newKRText}
                                onChange={(e) => setNewKRText(e.target.value)}
                                placeholder="Ej: 20 entrevistas con clientes o 'Definir pricing'"
                                onKeyPress={(e) => e.key === 'Enter' && handleAddKR()}
                                autoFocus
                            />
                            <button onClick={handleAddKR}>Agregar</button>
                        </div>
                    )}

                    {rock.keyResults.length > 0 && (
                        <>
                            <div className="kr-list">
                                {rock.keyResults.map(kr => (
                                    <div key={kr.id} className="kr-item">
                                        {kr.type === 'numeric' ? (
                                            <>
                                                <div className="kr-numeric" style={{ flex: 1 }}>
                                                    <span className="kr-numeric-display">
                                                        [{kr.current}/{kr.target}]
                                                    </span>
                                                    <span className="kr-text">{kr.text}</span>
                                                    <div className="kr-numeric-bar">
                                                        <div 
                                                            className="kr-numeric-bar-fill"
                                                            style={{ width: `${Math.min((kr.current / kr.target) * 100, 100)}%` }}
                                                        />
                                                    </div>
                                                    <input
                                                        type="number"
                                                        className="kr-numeric-input"
                                                        value={kr.current}
                                                        onChange={(e) => onUpdateNumericKR(kr.id, parseInt(e.target.value) || 0)}
                                                        min="0"
                                                        max={kr.target}
                                                    />
                                                </div>
                                                <button
                                                    className="btn-secondary btn-small"
                                                    onClick={() => onDeleteKR(kr.id)}
                                                >
                                                    âœ•
                                                </button>
                                            </>
                                        ) : (
                                            <>
                                                <input
                                                    type="checkbox"
                                                    className="kr-checkbox"
                                                    checked={kr.completed}
                                                    onChange={() => onToggleKR(kr.id)}
                                                />
                                                <span className={`kr-text ${kr.completed ? 'completed' : ''}`}>
                                                    {kr.text}
                                                </span>
                                                <button
                                                    className="btn-secondary btn-small"
                                                    onClick={() => onDeleteKR(kr.id)}
                                                >
                                                    âœ•
                                                </button>
                                            </>
                                        )}
                                    </div>
                                ))}
                            </div>
                            
                            <div className="progress-bar">
                                <div 
                                    className="progress-fill" 
                                    style={{ width: `${progress}%` }}
                                />
                            </div>
                            <div className="progress-text">
                                {Math.round(progress)}% completado
                            </div>
                        </>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
